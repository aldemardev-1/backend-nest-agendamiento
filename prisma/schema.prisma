// 1. GENERADOR
generator client {
  provider = "prisma-client-js"
}

// 2. DATASOURCE
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 3. ENUMS (Tipos fijos)
enum Role {
  SUPER_ADMIN
  OWNER
  EMPLOYEE
}

enum Plan {
  FREE
  PROFESIONAL
  EMPRESA
}

// 4. MODELOS

// --- USUARIO / DUEÑO DEL NEGOCIO ---
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  password     String
  businessName String
  
  // Campos de Perfil (Nuevos)
  phone        String?  // Opcional al inicio
  address      String?  // Opcional
  city         String?  // Opcional

  // Configuración de Cuenta
  role         Role     @default(OWNER)
  plan         Plan     @default(FREE)
  
  // Límites del Plan
  maxEmployees Int      @default(1)
  maxServices  Int      @default(1)
  
  planExpiresAt DateTime?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relaciones
  services     Service[]
  employees    Employee[]
  payments     Payment[]
  clientes     Cliente[]
  citas        Cita[]
}

// --- SERVICIO ---
model Service {
  id        String   @id @default(cuid())
  name      String
  duration  Int      // Minutos
  price     Float
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  citas     Cita[]
}

// --- EMPLEADO ---
model Employee {
  id        String   @id @default(cuid())
  name      String
  email     String?
  phone     String?
  color     String?  // Para el calendario
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  availability Availability[]
  citas        Cita[]
}

// --- DISPONIBILIDAD ---
model Availability {
  id          String  @id @default(cuid())
  dayOfWeek   Int     // 0 = Domingo, 1 = Lunes...
  isAvailable Boolean @default(false)
  startTime   String? // "09:00"
  endTime     String? // "18:00"
  
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, dayOfWeek])
}

// --- CLIENTE FINAL ---
model Cliente {
  id        String   @id @default(cuid())
  name      String
  email     String?
  phone     String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  citas     Cita[]

  // Un cliente es único por negocio + teléfono
  @@unique([userId, phone])
}

// --- CITA (BOOKING) ---
model Cita {
  id            String   @id @default(cuid())
  startTime     DateTime
  endTime       DateTime
  
  status        String   @default("PENDING") // PENDING, CONFIRMED, COMPLETED, CANCELLED
  notes         String?
  
  cancelToken   String   @unique @default(cuid()) @map("cancel_token")
  reminderSent  Boolean  @default(false) @map("reminder_sent")

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relaciones
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  employeeId    String
  employee      Employee @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  
  serviceId     String
  service       Service  @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  
  clienteId     String
  cliente       Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
}

// --- PAGOS (Suscripción del SaaS) ---
model Payment {
  id        String   @id @default(cuid())
  amount    Float
  currency  String   @default("COP")
  status    String   // PENDING, COMPLETED, FAILED
  reference String   @unique
  wompiId   String?  @unique
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    String
  user      User     @relation(fields: [userId], references: [id])
}